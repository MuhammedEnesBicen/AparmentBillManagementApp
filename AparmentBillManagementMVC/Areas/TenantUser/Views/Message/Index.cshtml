@{
    int tenantId = ViewBag.tenantId;
}

<button class="btn btn-primary" onclick="getMessages()">Get Messages</button>
<button class="btn btn-primary" onclick="getNewMessages()">Get new Messages</button>
    <div class=" messageSection bg-light bg-opacity-75" >
    
    <div class=" scroller " > <div id="messagesArea">  </div>

        <div id="spinner" class="align-middle spinner-border text-warning" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <div class="input-group ">
        <textarea id="textarea" type="text" class="form-control" placeholder="Enter your message" aria-label="Enter your message" aria-describedby="sendMessage"></textarea>
        <button class="btn " type="button" id="sendMessage" onclick="sendMessage()">
            Send
            <i class="fa fa-send"></i>
        </button>
    </div>
    </div>

@section Scripts {
    <script>
        $(document).on("click", ".message", function () {
            $(this).children().last().toggleClass("visually-hidden");
        });

        $(document).ready(function () {
            getMessages();

            // window.setInterval(function () {
            //     console.log("getMessages");
            //     getNewMessages();
            // }, 5000);
        });

        const textareaEle = document.getElementById('textarea');

        textareaEle.addEventListener('input', () => {
            textarea.style.height = 'auto';
            textarea.style.height = `${textarea.scrollHeight}px`;

        });


        function getMessages() {
            
            $("#spinner").prop("hidden",false);

            $.post("Messages", { tenantId: @tenantId}, function (data) {
                $("#spinner").prop("hidden", true);
                $("#messagesArea").html(data);
            }).fail(function () {
                $("#spinner").prop("hidden", true);
                $.notify("Error while getting messages!");
            });
        }

        function sendMessage() {
            var message = $("#sendMessage").prev().val();
            if(message == "") {
                $.notify("Message Cant be empty!");
                return;
            }
            $.post("Message", { tenantId: @tenantId, text: message, sender: 0 }, function (data) {
                $("#messagesArea").append(data);
            });
        }

        function getNewMessages() {
            var messageId = $("#messagesArea > div > div > input");
messageId = messageId.last().attr("name");
            $.get("Message?tenantId="+ @tenantId + "&messageId="+messageId, function (data) {
                $("#messagesArea").append(data);
            });
        }

        function removeMessage(messageId) {
            $.ajax({
                url: "Delete?messageId=" + messageId,
                type: 'DELETE',
                success: function (result) {
                    var elementToRemove = $("#messagesArea > div > div > input[name='" + messageId + "']").parent().parent();
                    if (elementToRemove.next().hasClass("messageDiv") == false) {
                        if (elementToRemove.prev().hasClass("messageDateDivider") == true){
                            console.log(elementToRemove.prev());

                            elementToRemove.prev().remove();
                        }
                    }
                    elementToRemove.remove();
                    $.notify("Message removed!", { className: "success" });
                },
                error: function (result) {
                    $.notify("Error while deleting message!");
                }
            });
        }
    </script>
}